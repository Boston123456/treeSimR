<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Nathan Green" />

<meta name="date" content="2017-01-20" />

<title>treeSimR Vignette</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">treeSimR Vignette</h1>
<h4 class="author"><em>Nathan Green</em></h4>
<h4 class="date"><em>2017-01-20</em></h4>



<div id="initiate-trees" class="section level2">
<h2>Initiate trees</h2>
<p>Load a tree template from the  package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">path_dtree &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;raw data/LTBI_dtree-cost_SIMPLE.yaml&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;treeSimR&quot;</span>)
osList &lt;-<span class="st"> </span><span class="kw">yaml.load_file</span>(path_dtree)</code></pre></div>
<p>The raw decision tree file is a tab-spaced file such as the following:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml">    <span class="fu">name:</span> LTBI screening cost
    <span class="fu">distn:</span> unif
    <span class="fu">min:</span> 0
    <span class="fu">max:</span> 0
    <span class="fu">type:</span> logical
    <span class="fu">LTBI:</span>
      <span class="fu">p:</span> 0.3
      <span class="fu">distn:</span> unif
      <span class="fu">min:</span> 0
      <span class="fu">max:</span> 0
      <span class="fu">type:</span> chance
      <span class="fu">Not Agree to Screen:</span>
        <span class="fu">p:</span> 0.65
        <span class="fu">distn:</span> unif
        <span class="fu">min:</span> 0
        <span class="fu">max:</span> 0
        <span class="fu">type:</span> terminal
      <span class="fu">Agree to Screen:</span>
        <span class="fu">p:</span> 0.35
        <span class="fu">distn:</span> unif
        <span class="fu">min:</span> 30
        <span class="fu">max:</span> 30
        <span class="fu">type:</span> chance
        <span class="fu">Test Negative:</span>
          <span class="fu">p:</span> 0.05
          <span class="fu">distn:</span> unif
          <span class="fu">min:</span> 0
          <span class="fu">max:</span> 0
          <span class="fu">type:</span> terminal
        <span class="fu">Test Positive:</span>
          <span class="fu">p:</span> 0.95
          <span class="fu">distn:</span> unif
          <span class="fu">min:</span> 0
          <span class="fu">max:</span> 0
          <span class="fu">type:</span> chance
          <span class="fu">Not Start Treatment:</span>
            <span class="fu">p:</span> 0.5
            <span class="fu">distn:</span> unif
            <span class="fu">min:</span> 0
            <span class="fu">max:</span> 0
            <span class="fu">type:</span> terminal
          <span class="fu">Start Treatment:</span>
            <span class="fu">p:</span> 0.5
            <span class="fu">distn:</span> unif
            <span class="fu">min:</span> 200
            <span class="fu">max:</span> 200
            <span class="fu">type:</span> chance
            <span class="fu">Symptoms hepatotoxicity:</span>
              <span class="fu">p:</span> 1
              <span class="fu">distn:</span> unif
              <span class="fu">min:</span> 0
              <span class="fu">max:</span> 0
              <span class="fu">type:</span> chance
              <span class="fu">Symptoms nausea:</span>
                <span class="fu">p:</span> 1
                <span class="fu">distn:</span> unif
                <span class="fu">min:</span> 0
                <span class="fu">max:</span> 0
                <span class="fu">type:</span> chance
                <span class="fu">Complete Treatment:</span>
                  <span class="fu">p:</span> 0.9
                  <span class="fu">distn:</span> unif
                  <span class="fu">min:</span> 0
                  <span class="fu">max:</span> 0
                  <span class="fu">type:</span> chance
                  <span class="fu">Effective:</span>
                    <span class="fu">p:</span> 0.9
                    <span class="fu">distn:</span> unif
                    <span class="fu">min:</span> 0
                    <span class="fu">max:</span> 0
                    <span class="fu">type:</span> terminal
                  <span class="fu">Not Effective:</span>
                    <span class="fu">p:</span> 0.1
                    <span class="fu">distn:</span> unif
                    <span class="fu">min:</span> 0
                    <span class="fu">max:</span> 0
                    <span class="fu">type:</span> terminal
                <span class="fu">Not Complete Treatment:</span>
                  <span class="fu">p:</span> 0.1
                  <span class="fu">distn:</span> unif
                  <span class="fu">min:</span> 0
                  <span class="fu">max:</span> 0
                  <span class="fu">type:</span> terminal
    <span class="fu">non-LTBI:</span>
      <span class="fu">p:</span> 0.7
      <span class="fu">distn:</span> unif
      <span class="fu">min:</span> 0
      <span class="fu">max:</span> 0
      <span class="fu">type:</span> chance
      <span class="fu">Not Agree to Screen:</span>
        <span class="fu">p:</span> 0.65
        <span class="fu">distn:</span> unif
        <span class="fu">min:</span> 0
        <span class="fu">max:</span> 0
        <span class="fu">type:</span> terminal
      <span class="fu">Agree to Screen:</span>
        <span class="fu">p:</span> 0.35
        <span class="fu">distn:</span> unif
        <span class="fu">min:</span> 30
        <span class="fu">max:</span> 30
        <span class="fu">type:</span> chance
        <span class="fu">Test Negative:</span>
          <span class="fu">p:</span> 0.95
          <span class="fu">distn:</span> unif
          <span class="fu">min:</span> 0
          <span class="fu">max:</span> 0
          <span class="fu">type:</span> terminal
        <span class="fu">Test Positive:</span>
          <span class="fu">p:</span> 0.05
          <span class="fu">distn:</span> unif
          <span class="fu">min:</span> 0
          <span class="fu">max:</span> 0
          <span class="fu">type:</span> chance
          <span class="fu">Not Start Treatment:</span>
            <span class="fu">p:</span> 0.5
            <span class="fu">distn:</span> unif
            <span class="fu">min:</span> 0
            <span class="fu">max:</span> 0
            <span class="fu">type:</span> terminal
          <span class="fu">Start Treatment:</span>
            <span class="fu">p:</span> 0.5
            <span class="fu">distn:</span> unif
            <span class="fu">min:</span> 200
            <span class="fu">max:</span> 200
            <span class="fu">type:</span> chance
            <span class="fu">Symptoms hepatotoxicity:</span>
              <span class="fu">p:</span> 1
              <span class="fu">distn:</span> unif
              <span class="fu">min:</span> 0
              <span class="fu">max:</span> 0
              <span class="fu">type:</span> chance
              <span class="fu">Symptoms nausea:</span>
                <span class="fu">p:</span> 1
                <span class="fu">distn:</span> unif
                <span class="fu">min:</span> 0
                <span class="fu">max:</span> 0
                <span class="fu">type:</span> chance
                <span class="fu">Complete Treatment:</span>
                  <span class="fu">p:</span> 0.9
                  <span class="fu">distn:</span> unif
                  <span class="fu">min:</span> 0
                  <span class="fu">max:</span> 0
                  <span class="fu">type:</span> terminal
                <span class="fu">Not Complete Treatment:</span>
                  <span class="fu">p:</span> 0.1
                  <span class="fu">distn:</span> unif
                  <span class="fu">min:</span> 0
                  <span class="fu">max:</span> 0
                  <span class="fu">type:</span> terminal</code></pre></div>
<p>We save this to a .yaml text file and then give it as a yaml file to a data.tree object using the yaml and data.tree packages. This is then represented as a list in R.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># osList &lt;- yaml.load(yaml)</span>
osNode &lt;-<span class="st"> </span><span class="kw">as.Node</span>(osList)
osNode</code></pre></div>
<pre><code>##                                             levelName
## 1  LTBI screening cost                               
## 2   ¦--LTBI                                          
## 3   ¦   ¦--Not Agree to Screen                       
## 4   ¦   °--Agree to Screen                           
## 5   ¦       ¦--Test Negative                         
## 6   ¦       °--Test Positive                         
## 7   ¦           ¦--Not Start Treatment               
## 8   ¦           °--Start Treatment                   
## 9   ¦               °--Symptoms hepatotoxicity       
## 10  ¦                   °--Symptoms nausea           
## 11  ¦                       ¦--Complete Treatment    
## 12  ¦                       ¦   ¦--Effective         
## 13  ¦                       ¦   °--Not Effective     
## 14  ¦                       °--Not Complete Treatment
## 15  °--non-LTBI                                      
## 16      ¦--Not Agree to Screen                       
## 17      °--Agree to Screen                           
## 18          ¦--Test Negative                         
## 19          °--Test Positive                         
## 20              ¦--Not Start Treatment               
## 21              °--Start Treatment                   
## 22                  °--Symptoms hepatotoxicity       
## 23                      °--Symptoms nausea           
## 24                          ¦--Complete Treatment    
## 25                          °--Not Complete Treatment</code></pre>
<p>Better still, use the  package function to do this, checking for tree integrity and defining an additional costeffectiveness.tree class.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">scenarios_cost &lt;-<span class="st"> </span><span class="kw">find_package_root_file</span>(<span class="st">&quot;raw data&quot;</span>,
                                         <span class="st">&quot;scenario-parameter-values_cost.csv&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">                    </span><span class="kw">read.csv</span>()
<span class="co"># scenarios_cost &lt;- read.csv(&quot;raw data/scenario-parameter-values_cost.csv&quot;)</span>

CEtree &lt;-<span class="st"> </span>treeSimR::<span class="kw">costeffectiveness_tree</span>(<span class="dt">yaml_tree =</span> path_dtree,
                                           <span class="dt">data_val =</span> scenarios_cost)
osNode &lt;-<span class="st"> </span>CEtree$osNode
<span class="kw">print</span>(osNode)</code></pre></div>
<pre><code>##                                             levelName distn max min     type    p
## 1  LTBI screening cost                                 unif   0   0  logical   NA
## 2   ¦--LTBI                                            unif   0   0   chance 0.30
## 3   ¦   ¦--Not Agree to Screen                         unif   0   0 terminal 0.65
## 4   ¦   °--Agree to Screen                             unif  30  30   chance 0.35
## 5   ¦       ¦--Test Negative                           unif   0   0 terminal 0.05
## 6   ¦       °--Test Positive                           unif   0   0   chance 0.95
## 7   ¦           ¦--Not Start Treatment                 unif   0   0 terminal 0.50
## 8   ¦           °--Start Treatment                     unif 200 200   chance 0.50
## 9   ¦               °--Symptoms hepatotoxicity         unif   0   0   chance 1.00
## 10  ¦                   °--Symptoms nausea             unif   0   0   chance 1.00
## 11  ¦                       ¦--Complete Treatment      unif   0   0   chance 0.90
## 12  ¦                       ¦   ¦--Effective           unif   0   0 terminal 0.90
## 13  ¦                       ¦   °--Not Effective       unif   0   0 terminal 0.10
## 14  ¦                       °--Not Complete Treatment  unif   0   0 terminal 0.10
## 15  °--non-LTBI                                        unif   0   0   chance 0.70
## 16      ¦--Not Agree to Screen                         unif   0   0 terminal 0.65
## 17      °--Agree to Screen                             unif  30  30   chance 0.35
## 18          ¦--Test Negative                           unif   0   0 terminal 0.95
## 19          °--Test Positive                           unif   0   0   chance 0.05
## 20              ¦--Not Start Treatment                 unif   0   0 terminal 0.50
## 21              °--Start Treatment                     unif 200 200   chance 0.50
## 22                  °--Symptoms hepatotoxicity         unif   0   0   chance 1.00
## 23                      °--Symptoms nausea             unif   0   0   chance 1.00
## 24                          ¦--Complete Treatment      unif   0   0 terminal 0.90
## 25                          °--Not Complete Treatment  unif   0   0 terminal 0.10</code></pre>
<p>A neat way of exploring the tree is with the <code>listviewer</code> package widget.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(listviewer)
l &lt;-<span class="st"> </span><span class="kw">ToListSimple</span>(osNode)
<span class="kw">jsonedit</span>(l)</code></pre></div>
</div>
<div id="simulate-a-scenario" class="section level2">
<h2>Simulate a scenario</h2>
<p>We can now sample values for each branch, given the distributions defined for each. This could be the cost or health detriment.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rpayoff &lt;-<span class="st"> </span>osNode$<span class="kw">Get</span>(sampleNode)
osNode$<span class="kw">Set</span>(<span class="dt">payoff =</span> rpayoff)
<span class="kw">print</span>(osNode)</code></pre></div>
<pre><code>##                                             levelName distn max min payoff     type    p
## 1  LTBI screening cost                                 unif   0   0      0  logical   NA
## 2   ¦--LTBI                                            unif   0   0      0   chance 0.30
## 3   ¦   ¦--Not Agree to Screen                         unif   0   0      0 terminal 0.65
## 4   ¦   °--Agree to Screen                             unif  30  30     30   chance 0.35
## 5   ¦       ¦--Test Negative                           unif   0   0      0 terminal 0.05
## 6   ¦       °--Test Positive                           unif   0   0      0   chance 0.95
## 7   ¦           ¦--Not Start Treatment                 unif   0   0      0 terminal 0.50
## 8   ¦           °--Start Treatment                     unif 200 200    200   chance 0.50
## 9   ¦               °--Symptoms hepatotoxicity         unif   0   0      0   chance 1.00
## 10  ¦                   °--Symptoms nausea             unif   0   0      0   chance 1.00
## 11  ¦                       ¦--Complete Treatment      unif   0   0      0   chance 0.90
## 12  ¦                       ¦   ¦--Effective           unif   0   0      0 terminal 0.90
## 13  ¦                       ¦   °--Not Effective       unif   0   0      0 terminal 0.10
## 14  ¦                       °--Not Complete Treatment  unif   0   0      0 terminal 0.10
## 15  °--non-LTBI                                        unif   0   0      0   chance 0.70
## 16      ¦--Not Agree to Screen                         unif   0   0      0 terminal 0.65
## 17      °--Agree to Screen                             unif  30  30     30   chance 0.35
## 18          ¦--Test Negative                           unif   0   0      0 terminal 0.95
## 19          °--Test Positive                           unif   0   0      0   chance 0.05
## 20              ¦--Not Start Treatment                 unif   0   0      0 terminal 0.50
## 21              °--Start Treatment                     unif 200 200    200   chance 0.50
## 22                  °--Symptoms hepatotoxicity         unif   0   0      0   chance 1.00
## 23                      °--Symptoms nausea             unif   0   0      0   chance 1.00
## 24                          ¦--Complete Treatment      unif   0   0      0 terminal 0.90
## 25                          °--Not Complete Treatment  unif   0   0      0 terminal 0.10</code></pre>
<p>Now given the sampled values, e.g. cost, and the probabilities, we can calculate the expected values at each node, from leaf to root.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">osNode$<span class="kw">Do</span>(payoff, <span class="dt">traversal =</span> <span class="st">&quot;post-order&quot;</span>, <span class="dt">filterFun =</span> isNotLeaf)
<span class="kw">print</span>(osNode)</code></pre></div>
<pre><code>##                                             levelName distn max min payoff     type    p
## 1  LTBI screening cost                                 unif   0   0  21.70  logical   NA
## 2   ¦--LTBI                                            unif   0   0  43.75   chance 0.30
## 3   ¦   ¦--Not Agree to Screen                         unif   0   0   0.00 terminal 0.65
## 4   ¦   °--Agree to Screen                             unif  30  30 125.00   chance 0.35
## 5   ¦       ¦--Test Negative                           unif   0   0   0.00 terminal 0.05
## 6   ¦       °--Test Positive                           unif   0   0 100.00   chance 0.95
## 7   ¦           ¦--Not Start Treatment                 unif   0   0   0.00 terminal 0.50
## 8   ¦           °--Start Treatment                     unif 200 200 200.00   chance 0.50
## 9   ¦               °--Symptoms hepatotoxicity         unif   0   0   0.00   chance 1.00
## 10  ¦                   °--Symptoms nausea             unif   0   0   0.00   chance 1.00
## 11  ¦                       ¦--Complete Treatment      unif   0   0   0.00   chance 0.90
## 12  ¦                       ¦   ¦--Effective           unif   0   0   0.00 terminal 0.90
## 13  ¦                       ¦   °--Not Effective       unif   0   0   0.00 terminal 0.10
## 14  ¦                       °--Not Complete Treatment  unif   0   0   0.00 terminal 0.10
## 15  °--non-LTBI                                        unif   0   0  12.25   chance 0.70
## 16      ¦--Not Agree to Screen                         unif   0   0   0.00 terminal 0.65
## 17      °--Agree to Screen                             unif  30  30  35.00   chance 0.35
## 18          ¦--Test Negative                           unif   0   0   0.00 terminal 0.95
## 19          °--Test Positive                           unif   0   0 100.00   chance 0.05
## 20              ¦--Not Start Treatment                 unif   0   0   0.00 terminal 0.50
## 21              °--Start Treatment                     unif 200 200 200.00   chance 0.50
## 22                  °--Symptoms hepatotoxicity         unif   0   0   0.00   chance 1.00
## 23                      °--Symptoms nausea             unif   0   0   0.00   chance 1.00
## 24                          ¦--Complete Treatment      unif   0   0   0.00 terminal 0.90
## 25                          °--Not Complete Treatment  unif   0   0   0.00 terminal 0.10</code></pre>
<p>Similarly to above, we have created a better wrapper function to perform these steps:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">osNode &lt;-<span class="st"> </span><span class="kw">calc_expectedValues</span>(osNode)
<span class="kw">print</span>(osNode)</code></pre></div>
<pre><code>##                                             levelName distn max min payoff sampled     type    p
## 1  LTBI screening cost                                 unif   0   0  21.70       0  logical   NA
## 2   ¦--LTBI                                            unif   0   0  43.75       0   chance 0.30
## 3   ¦   ¦--Not Agree to Screen                         unif   0   0   0.00       0 terminal 0.65
## 4   ¦   °--Agree to Screen                             unif  30  30 125.00      30   chance 0.35
## 5   ¦       ¦--Test Negative                           unif   0   0   0.00       0 terminal 0.05
## 6   ¦       °--Test Positive                           unif   0   0 100.00       0   chance 0.95
## 7   ¦           ¦--Not Start Treatment                 unif   0   0   0.00       0 terminal 0.50
## 8   ¦           °--Start Treatment                     unif 200 200 200.00     200   chance 0.50
## 9   ¦               °--Symptoms hepatotoxicity         unif   0   0   0.00       0   chance 1.00
## 10  ¦                   °--Symptoms nausea             unif   0   0   0.00       0   chance 1.00
## 11  ¦                       ¦--Complete Treatment      unif   0   0   0.00       0   chance 0.90
## 12  ¦                       ¦   ¦--Effective           unif   0   0   0.00       0 terminal 0.90
## 13  ¦                       ¦   °--Not Effective       unif   0   0   0.00       0 terminal 0.10
## 14  ¦                       °--Not Complete Treatment  unif   0   0   0.00       0 terminal 0.10
## 15  °--non-LTBI                                        unif   0   0  12.25       0   chance 0.70
## 16      ¦--Not Agree to Screen                         unif   0   0   0.00       0 terminal 0.65
## 17      °--Agree to Screen                             unif  30  30  35.00      30   chance 0.35
## 18          ¦--Test Negative                           unif   0   0   0.00       0 terminal 0.95
## 19          °--Test Positive                           unif   0   0 100.00       0   chance 0.05
## 20              ¦--Not Start Treatment                 unif   0   0   0.00       0 terminal 0.50
## 21              °--Start Treatment                     unif 200 200 200.00     200   chance 0.50
## 22                  °--Symptoms hepatotoxicity         unif   0   0   0.00       0   chance 1.00
## 23                      °--Symptoms nausea             unif   0   0   0.00       0   chance 1.00
## 24                          ¦--Complete Treatment      unif   0   0   0.00       0 terminal 0.90
## 25                          °--Not Complete Treatment  unif   0   0   0.00       0 terminal 0.10</code></pre>
</div>
<div id="monte-carlo-forward-simulation" class="section level2">
<h2>Monte Carlo forward simulation</h2>
<p>We are now in a position to do a probability sensitivity analysis (PSA) and calculate multiple realisations for specific nodes e.g. those at which a decision is to be made.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">MonteCarlo_expectedValues</span>(osNode, <span class="dt">n =</span> <span class="dv">10</span>)</code></pre></div>
<pre><code>## $`expected values`
##       [,1]
##  [1,] 21.7
##  [2,] 21.7
##  [3,] 21.7
##  [4,] 21.7
##  [5,] 21.7
##  [6,] 21.7
##  [7,] 21.7
##  [8,] 21.7
##  [9,] 21.7
## [10,] 21.7
## 
## $`node names`
## [1] &quot;LTBI screening cost&quot;</code></pre>
</div>
<div id="pathway-probabilities" class="section level2">
<h2>Pathway Probabilities</h2>
<p>To feed into a compartmental model like a Markov model we need state probabilities. That is, the probability of ending-up in the one of the terminal state of the tree that are also starting states for the other model. These are calculated by taking the product of the probabilities along each pathway from root to leaf.</p>
<p>Once again, we’ve written a function to do this, which we can append to the the tree. Below we give the terminal states in a dataframe.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">path_probs &lt;-<span class="st"> </span><span class="kw">calc_pathway_probs</span>(osNode)
osNode$<span class="kw">Set</span>(<span class="dt">path_probs =</span> path_probs)

terminal_states &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">pathname =</span> osNode$<span class="kw">Get</span>(<span class="st">'pathString'</span>, <span class="dt">filterFun =</span> isLeaf),
                              <span class="dt">path_probs =</span> osNode$<span class="kw">Get</span>(<span class="st">'path_probs'</span>, <span class="dt">filterFun =</span> isLeaf))
terminal_states</code></pre></div>
<pre><code>##                                                                                                                                           pathname path_probs
## 1                                                                                                     LTBI screening cost/LTBI/Not Agree to Screen 0.19500000
## 2                                                                                           LTBI screening cost/LTBI/Agree to Screen/Test Negative 0.00525000
## 3                                                                       LTBI screening cost/LTBI/Agree to Screen/Test Positive/Not Start Treatment 0.04987500
## 4      LTBI screening cost/LTBI/Agree to Screen/Test Positive/Start Treatment/Symptoms hepatotoxicity/Symptoms nausea/Complete Treatment/Effective 0.04039875
## 5  LTBI screening cost/LTBI/Agree to Screen/Test Positive/Start Treatment/Symptoms hepatotoxicity/Symptoms nausea/Complete Treatment/Not Effective 0.00448875
## 6            LTBI screening cost/LTBI/Agree to Screen/Test Positive/Start Treatment/Symptoms hepatotoxicity/Symptoms nausea/Not Complete Treatment 0.00498750
## 7                                                                                                 LTBI screening cost/non-LTBI/Not Agree to Screen 0.45500000
## 8                                                                                       LTBI screening cost/non-LTBI/Agree to Screen/Test Negative 0.23275000
## 9                                                                   LTBI screening cost/non-LTBI/Agree to Screen/Test Positive/Not Start Treatment 0.00612500
## 10           LTBI screening cost/non-LTBI/Agree to Screen/Test Positive/Start Treatment/Symptoms hepatotoxicity/Symptoms nausea/Complete Treatment 0.00551250
## 11       LTBI screening cost/non-LTBI/Agree to Screen/Test Positive/Start Treatment/Symptoms hepatotoxicity/Symptoms nausea/Not Complete Treatment 0.00061250</code></pre>
<p>Specifically, the starting state probabilities of the subsequent compartmental model are for aggregated sub-populations. We can simply sum over these in an ad-hoc way.</p>
<p>The non-LTBI individuals either never had LTBI or where successfully treated.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">startstate.nonLTBI &lt;-<span class="st"> </span><span class="kw">grepl</span>(<span class="st">&quot;/Complete Treatment&quot;</span>, <span class="dt">x =</span> terminal_states$pathname) |<span class="st"> </span><span class="kw">grepl</span>(<span class="st">&quot;nonLTBI&quot;</span>, <span class="dt">x =</span> terminal_states$pathname)
startstate.LTBI &lt;-<span class="st"> </span>!startstate.nonLTBI</code></pre></div>
<p>The expected proportion of individuals in LTBI and non-LTBI after screening is thus,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">healthstatus &lt;-<span class="st"> </span><span class="ot">NA</span>
healthstatus[startstate.nonLTBI] &lt;-<span class="st"> &quot;nonLTBI&quot;</span>
healthstatus[startstate.LTBI] &lt;-<span class="st"> &quot;LTBI&quot;</span>

<span class="kw">aggregate</span>(terminal_states$path_probs, <span class="dt">by=</span><span class="kw">list</span>(healthstatus), <span class="dt">FUN=</span>sum)</code></pre></div>
<pre><code>##   Group.1      x
## 1    LTBI 0.9496
## 2 nonLTBI 0.0504</code></pre>
<p>Further, we can sample from the terminal state probabilities to give a sample of compartmental model start state proportions. This can capture the variability due to the cohort size.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">samplesize &lt;-<span class="st"> </span><span class="dv">100000</span>
numsamples &lt;-<span class="st"> </span><span class="dv">10</span>

sample.mat &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dt">nrow =</span> <span class="kw">nrow</span>(terminal_states), <span class="dt">ncol =</span> numsamples)
for (i in <span class="dv">1</span>:numsamples){
  
  sample.mat[,i] &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="kw">sample</span>(<span class="dt">x =</span> <span class="dv">1</span>:<span class="kw">nrow</span>(terminal_states), <span class="dt">size =</span> samplesize, <span class="dt">prob =</span> terminal_states$path_probs, <span class="dt">replace =</span> <span class="ot">TRUE</span>))/samplesize
}

<span class="kw">head</span>(sample.mat)</code></pre></div>
<pre><code>##         [,1]    [,2]    [,3]    [,4]    [,5]    [,6]    [,7]    [,8]    [,9]   [,10]
## [1,] 0.19683 0.19520 0.19616 0.19480 0.19083 0.19649 0.19428 0.19396 0.19531 0.19431
## [2,] 0.00517 0.00506 0.00541 0.00524 0.00564 0.00512 0.00547 0.00476 0.00516 0.00496
## [3,] 0.04983 0.05047 0.05015 0.05040 0.04942 0.05021 0.04929 0.04955 0.05036 0.05052
## [4,] 0.04112 0.03989 0.04022 0.04144 0.03940 0.04085 0.03987 0.04085 0.03976 0.04069
## [5,] 0.00464 0.00422 0.00398 0.00453 0.00522 0.00483 0.00444 0.00456 0.00443 0.00460
## [6,] 0.00474 0.00501 0.00490 0.00518 0.00530 0.00525 0.00499 0.00512 0.00495 0.00472</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(sample.mat, <span class="dv">2</span>, function(x) <span class="kw">aggregate</span>(x, <span class="dt">by=</span><span class="kw">list</span>(healthstatus), <span class="dt">FUN=</span>sum))</code></pre></div>
<pre><code>## [[1]]
##   Group.1       x
## 1    LTBI 0.94882
## 2 nonLTBI 0.05118
## 
## [[2]]
##   Group.1       x
## 1    LTBI 0.95039
## 2 nonLTBI 0.04961
## 
## [[3]]
##   Group.1       x
## 1    LTBI 0.95046
## 2 nonLTBI 0.04954
## 
## [[4]]
##   Group.1       x
## 1    LTBI 0.94854
## 2 nonLTBI 0.05146
## 
## [[5]]
##   Group.1       x
## 1    LTBI 0.94996
## 2 nonLTBI 0.05004
## 
## [[6]]
##   Group.1       x
## 1    LTBI 0.94899
## 2 nonLTBI 0.05101
## 
## [[7]]
##   Group.1       x
## 1    LTBI 0.95021
## 2 nonLTBI 0.04979
## 
## [[8]]
##   Group.1       x
## 1    LTBI 0.94916
## 2 nonLTBI 0.05084
## 
## [[9]]
##   Group.1       x
## 1    LTBI 0.95039
## 2 nonLTBI 0.04961
## 
## [[10]]
##   Group.1       x
## 1    LTBI 0.94892
## 2 nonLTBI 0.05108</code></pre>
<p>The  function to do this is</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">get_start_state_proportions</span>(terminal_states$path_probs, healthstatus, samplesize, numsamples)</code></pre></div>
</div>
<div id="risk-profile" class="section level2">
<h2>Risk Profile</h2>
<p>Further, the pathway probabilities can be used to give the distribution of the terminal state values e.g. cost or time. This is called the risk profile of the decision tree.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">osNode &lt;-<span class="st"> </span><span class="kw">calc_riskprofile</span>(osNode)
<span class="kw">print</span>(osNode, <span class="st">&quot;type&quot;</span>, <span class="st">&quot;path_prob&quot;</span>, <span class="st">&quot;path_payoff&quot;</span>)</code></pre></div>
<pre><code>##                                             levelName distn max min path_payoff  path_prob path_probs payoff sampled     type    p
## 1  LTBI screening cost                                 unif   0   0       21.70 1.00000000 1.00000000  21.70       0  logical   NA
## 2   ¦--LTBI                                            unif   0   0       65.45 0.30000000 0.30000000  43.75       0   chance 0.30
## 3   ¦   ¦--Not Agree to Screen                         unif   0   0       65.45 0.19500000 0.19500000   0.00       0 terminal 0.65
## 4   ¦   °--Agree to Screen                             unif  30  30      190.45 0.10500000 0.10500000 125.00      30   chance 0.35
## 5   ¦       ¦--Test Negative                           unif   0   0      190.45 0.00525000 0.00525000   0.00       0 terminal 0.05
## 6   ¦       °--Test Positive                           unif   0   0      290.45 0.09975000 0.09975000 100.00       0   chance 0.95
## 7   ¦           ¦--Not Start Treatment                 unif   0   0      290.45 0.04987500 0.04987500   0.00       0 terminal 0.50
## 8   ¦           °--Start Treatment                     unif 200 200      490.45 0.04987500 0.04987500 200.00     200   chance 0.50
## 9   ¦               °--Symptoms hepatotoxicity         unif   0   0      490.45 0.04987500 0.04987500   0.00       0   chance 1.00
## 10  ¦                   °--Symptoms nausea             unif   0   0      490.45 0.04987500 0.04987500   0.00       0   chance 1.00
## 11  ¦                       ¦--Complete Treatment      unif   0   0      490.45 0.04488750 0.04488750   0.00       0   chance 0.90
## 12  ¦                       ¦   ¦--Effective           unif   0   0      490.45 0.04039875 0.04039875   0.00       0 terminal 0.90
## 13  ¦                       ¦   °--Not Effective       unif   0   0      490.45 0.00448875 0.00448875   0.00       0 terminal 0.10
## 14  ¦                       °--Not Complete Treatment  unif   0   0      490.45 0.00498750 0.00498750   0.00       0 terminal 0.10
## 15  °--non-LTBI                                        unif   0   0       33.95 0.70000000 0.70000000  12.25       0   chance 0.70
## 16      ¦--Not Agree to Screen                         unif   0   0       33.95 0.45500000 0.45500000   0.00       0 terminal 0.65
## 17      °--Agree to Screen                             unif  30  30       68.95 0.24500000 0.24500000  35.00      30   chance 0.35
## 18          ¦--Test Negative                           unif   0   0       68.95 0.23275000 0.23275000   0.00       0 terminal 0.95
## 19          °--Test Positive                           unif   0   0      168.95 0.01225000 0.01225000 100.00       0   chance 0.05
## 20              ¦--Not Start Treatment                 unif   0   0      168.95 0.00612500 0.00612500   0.00       0 terminal 0.50
## 21              °--Start Treatment                     unif 200 200      368.95 0.00612500 0.00612500 200.00     200   chance 0.50
## 22                  °--Symptoms hepatotoxicity         unif   0   0      368.95 0.00612500 0.00612500   0.00       0   chance 1.00
## 23                      °--Symptoms nausea             unif   0   0      368.95 0.00612500 0.00612500   0.00       0   chance 1.00
## 24                          ¦--Complete Treatment      unif   0   0      368.95 0.00551250 0.00551250   0.00       0 terminal 0.90
## 25                          °--Not Complete Treatment  unif   0   0      368.95 0.00061250 0.00061250   0.00       0 terminal 0.10</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">data.frame</span>(osNode$<span class="kw">Get</span>(<span class="st">'path_payoff'</span>, <span class="dt">filterFun =</span> isLeaf),
           osNode$<span class="kw">Get</span>(<span class="st">'path_prob'</span>, <span class="dt">filterFun =</span> isLeaf)), <span class="dt">type=</span><span class="st">&quot;h&quot;</span>,
     <span class="dt">xlab=</span><span class="st">&quot;payoff&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;probability&quot;</span>)</code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
</div>
<div id="deterministic-sensitivity-analysis" class="section level2">
<h2>Deterministic sensitivity analysis</h2>
<p>The above methods employ probability sensitivity analysis. We can also do deterministic (or scenario) based sensitivity analysis. That is we simulate the model over a grid of pre-specified parameter values. We have already included these above in the construction of the costeffectiveness_object in <code>data$data_prob</code> and <code>data$data_val</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(CEtree)</code></pre></div>
<pre><code>## $osNode
##                                             levelName distn max min path_payoff  path_prob path_probs payoff sampled     type    p
## 1  LTBI screening cost                                 unif   0   0       21.70 1.00000000 1.00000000  21.70       0  logical   NA
## 2   ¦--LTBI                                            unif   0   0       65.45 0.30000000 0.30000000  43.75       0   chance 0.30
## 3   ¦   ¦--Not Agree to Screen                         unif   0   0       65.45 0.19500000 0.19500000   0.00       0 terminal 0.65
## 4   ¦   °--Agree to Screen                             unif  30  30      190.45 0.10500000 0.10500000 125.00      30   chance 0.35
## 5   ¦       ¦--Test Negative                           unif   0   0      190.45 0.00525000 0.00525000   0.00       0 terminal 0.05
## 6   ¦       °--Test Positive                           unif   0   0      290.45 0.09975000 0.09975000 100.00       0   chance 0.95
## 7   ¦           ¦--Not Start Treatment                 unif   0   0      290.45 0.04987500 0.04987500   0.00       0 terminal 0.50
## 8   ¦           °--Start Treatment                     unif 200 200      490.45 0.04987500 0.04987500 200.00     200   chance 0.50
## 9   ¦               °--Symptoms hepatotoxicity         unif   0   0      490.45 0.04987500 0.04987500   0.00       0   chance 1.00
## 10  ¦                   °--Symptoms nausea             unif   0   0      490.45 0.04987500 0.04987500   0.00       0   chance 1.00
## 11  ¦                       ¦--Complete Treatment      unif   0   0      490.45 0.04488750 0.04488750   0.00       0   chance 0.90
## 12  ¦                       ¦   ¦--Effective           unif   0   0      490.45 0.04039875 0.04039875   0.00       0 terminal 0.90
## 13  ¦                       ¦   °--Not Effective       unif   0   0      490.45 0.00448875 0.00448875   0.00       0 terminal 0.10
## 14  ¦                       °--Not Complete Treatment  unif   0   0      490.45 0.00498750 0.00498750   0.00       0 terminal 0.10
## 15  °--non-LTBI                                        unif   0   0       33.95 0.70000000 0.70000000  12.25       0   chance 0.70
## 16      ¦--Not Agree to Screen                         unif   0   0       33.95 0.45500000 0.45500000   0.00       0 terminal 0.65
## 17      °--Agree to Screen                             unif  30  30       68.95 0.24500000 0.24500000  35.00      30   chance 0.35
## 18          ¦--Test Negative                           unif   0   0       68.95 0.23275000 0.23275000   0.00       0 terminal 0.95
## 19          °--Test Positive                           unif   0   0      168.95 0.01225000 0.01225000 100.00       0   chance 0.05
## 20              ¦--Not Start Treatment                 unif   0   0      168.95 0.00612500 0.00612500   0.00       0 terminal 0.50
## 21              °--Start Treatment                     unif 200 200      368.95 0.00612500 0.00612500 200.00     200   chance 0.50
## 22                  °--Symptoms hepatotoxicity         unif   0   0      368.95 0.00612500 0.00612500   0.00       0   chance 1.00
## 23                      °--Symptoms nausea             unif   0   0      368.95 0.00612500 0.00612500   0.00       0   chance 1.00
## 24                          ¦--Complete Treatment      unif   0   0      368.95 0.00551250 0.00551250   0.00       0 terminal 0.90
## 25                          °--Not Complete Treatment  unif   0   0      368.95 0.00061250 0.00061250   0.00       0 terminal 0.10
## 
## $data
## $data$data_prob
## [1] NA
## 
## $data$data_val
##   scenario distn min max            node
## 1        1  unif  20  20 Agree to Screen
## 2        2  unif  50  50 Agree to Screen
## 3        3  unif 100 100 Agree to Screen
## 
## 
## attr(,&quot;details&quot;)
## [1] &quot;&quot;
## attr(,&quot;class&quot;)
## [1] &quot;costeffectiveness_object&quot; &quot;list&quot;</code></pre>
<p>Select a scenario number and run:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># transform to tidy format</span>
<span class="co"># scenario_parameter_p.melt &lt;- reshape2::melt(data = CEtree$data$data_prob,</span>
<span class="co">#                                             id.vars = &quot;scenario&quot;, variable.name = &quot;node&quot;, value.name = &quot;p&quot;)</span>

<span class="kw">assign_branch_values</span>(<span class="dt">osNode.cost =</span> osNode,
                     <span class="dt">osNode.health =</span> osNode,
                     <span class="co"># parameter_p = subset(scenario_parameter_p.melt, scenario == 1),</span>
                     <span class="dt">parameter_cost =</span> <span class="kw">subset</span>(CEtree$data$data_val, scenario ==<span class="st"> </span><span class="dv">1</span>)) 
<span class="kw">print</span>(CEtree$osNode)</code></pre></div>
<pre><code>##                                             levelName distn max min path_payoff  path_prob path_probs payoff sampled     type    p
## 1  LTBI screening cost                                 unif   0   0       21.70 1.00000000 1.00000000  21.70       0  logical   NA
## 2   ¦--LTBI                                            unif   0   0       65.45 0.30000000 0.30000000  43.75       0   chance 0.30
## 3   ¦   ¦--Not Agree to Screen                         unif   0   0       65.45 0.19500000 0.19500000   0.00       0 terminal 0.65
## 4   ¦   °--Agree to Screen                             unif  20  20      190.45 0.10500000 0.10500000 125.00      30   chance 0.35
## 5   ¦       ¦--Test Negative                           unif   0   0      190.45 0.00525000 0.00525000   0.00       0 terminal 0.05
## 6   ¦       °--Test Positive                           unif   0   0      290.45 0.09975000 0.09975000 100.00       0   chance 0.95
## 7   ¦           ¦--Not Start Treatment                 unif   0   0      290.45 0.04987500 0.04987500   0.00       0 terminal 0.50
## 8   ¦           °--Start Treatment                     unif 200 200      490.45 0.04987500 0.04987500 200.00     200   chance 0.50
## 9   ¦               °--Symptoms hepatotoxicity         unif   0   0      490.45 0.04987500 0.04987500   0.00       0   chance 1.00
## 10  ¦                   °--Symptoms nausea             unif   0   0      490.45 0.04987500 0.04987500   0.00       0   chance 1.00
## 11  ¦                       ¦--Complete Treatment      unif   0   0      490.45 0.04488750 0.04488750   0.00       0   chance 0.90
## 12  ¦                       ¦   ¦--Effective           unif   0   0      490.45 0.04039875 0.04039875   0.00       0 terminal 0.90
## 13  ¦                       ¦   °--Not Effective       unif   0   0      490.45 0.00448875 0.00448875   0.00       0 terminal 0.10
## 14  ¦                       °--Not Complete Treatment  unif   0   0      490.45 0.00498750 0.00498750   0.00       0 terminal 0.10
## 15  °--non-LTBI                                        unif   0   0       33.95 0.70000000 0.70000000  12.25       0   chance 0.70
## 16      ¦--Not Agree to Screen                         unif   0   0       33.95 0.45500000 0.45500000   0.00       0 terminal 0.65
## 17      °--Agree to Screen                             unif  20  20       68.95 0.24500000 0.24500000  35.00      30   chance 0.35
## 18          ¦--Test Negative                           unif   0   0       68.95 0.23275000 0.23275000   0.00       0 terminal 0.95
## 19          °--Test Positive                           unif   0   0      168.95 0.01225000 0.01225000 100.00       0   chance 0.05
## 20              ¦--Not Start Treatment                 unif   0   0      168.95 0.00612500 0.00612500   0.00       0 terminal 0.50
## 21              °--Start Treatment                     unif 200 200      368.95 0.00612500 0.00612500 200.00     200   chance 0.50
## 22                  °--Symptoms hepatotoxicity         unif   0   0      368.95 0.00612500 0.00612500   0.00       0   chance 1.00
## 23                      °--Symptoms nausea             unif   0   0      368.95 0.00612500 0.00612500   0.00       0   chance 1.00
## 24                          ¦--Complete Treatment      unif   0   0      368.95 0.00551250 0.00551250   0.00       0 terminal 0.90
## 25                          °--Not Complete Treatment  unif   0   0      368.95 0.00061250 0.00061250   0.00       0 terminal 0.10</code></pre>
</div>
<div id="optimal-decisions" class="section level2">
<h2>Optimal decisions</h2>
<p>TODO</p>
<p>We can get the software to calculate the optimal decision for us, rather than returning the expections to compare. This can be done from right to left, iteratively.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">##TODO##
osNode$<span class="kw">Do</span>(decision, <span class="dt">filterFun =</span> function(x) x$type ==<span class="st"> 'decision'</span>)
osNode$<span class="kw">Get</span>(<span class="st">'decision'</span>)[<span class="dv">1</span>]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">##TODO##
## probabilty of successfully &amp; correctly treating LTBI
dummy &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, osNode$totalCount)
dummy[<span class="dv">12</span>] &lt;-<span class="st"> </span><span class="dv">1</span>
osNode$<span class="kw">Set</span>(<span class="dt">payoff =</span> dummy)
<span class="kw">print</span>(osNode, <span class="st">&quot;type&quot;</span>, <span class="st">&quot;p&quot;</span>, <span class="st">&quot;distn&quot;</span>, <span class="st">&quot;mean&quot;</span>, <span class="st">&quot;sd&quot;</span>, <span class="st">&quot;payoff&quot;</span>)
osNode$<span class="kw">Do</span>(payoff, <span class="dt">traversal =</span> <span class="st">&quot;post-order&quot;</span>, <span class="dt">filterFun =</span> isNotLeaf)
<span class="kw">print</span>(osNode, <span class="st">&quot;type&quot;</span>, <span class="st">&quot;p&quot;</span>, <span class="st">&quot;distn&quot;</span>, <span class="st">&quot;mean&quot;</span>, <span class="st">&quot;sd&quot;</span>, <span class="st">&quot;payoff&quot;</span>)
osNode$<span class="kw">Get</span>(<span class="st">'payoff'</span>)[<span class="dv">1</span>]</code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
